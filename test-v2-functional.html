<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Iframe v2 - Functional Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        h1 {
            margin: 0 0 10px 0;
        }
        
        .version-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .test-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-description {
            color: #666;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 5px;
        }
        
        .iframe-container {
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: #fafafa;
            position: relative;
            min-height: 400px;
        }
        
        .iframe-label {
            position: absolute;
            top: -12px;
            left: 20px;
            background: white;
            padding: 0 10px;
            color: #667eea;
            font-weight: 600;
            font-size: 14px;
        }
        
        .console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .console-line {
            margin: 3px 0;
            line-height: 1.4;
        }
        
        .console-success { color: #4ec9b0; }
        .console-warning { color: #ffcc00; }
        .console-error { color: #f48771; }
        .console-info { color: #569cd6; }
        
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a67d8; }
        
        .btn-secondary { background: #48bb78; color: white; }
        .btn-secondary:hover { background: #38a169; }
        
        .btn-danger { background: #f56565; color: white; }
        .btn-danger:hover { background: #e53e3e; }
        
        .btn-warning { background: #ed8936; color: white; }
        .btn-warning:hover { background: #dd6b20; }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .status-connected {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status-waiting {
            background: #feebc8;
            color: #7c2d12;
        }
        
        .status-error {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .status-fallback {
            background: #e6fffa;
            color: #234e52;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .info-card h4 {
            margin-top: 0;
            color: #333;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 14px;
        }
        
        .metric-value {
            font-weight: 600;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .comparison-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .status-icon {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Smart Iframe v2 - Functional Test Suite</h1>
        <span class="version-badge">Version 2.0 - Local Testing</span>
    </div>

    <!-- Test 1: Same-Origin iframe -->
    <div class="test-section">
        <div class="test-title">
            <span class="status-icon">üè†</span>
            Test 1: Same-Origin iframe (Perfect Integration)
        </div>
        <div class="test-description">
            <strong>Testing:</strong> Same-origin functionality with full access to iframe content.<br>
            <strong>Expected:</strong> Perfect height detection, instant URL monitoring, no restrictions.<br>
            <strong>File:</strong> local-form.html (this domain)
        </div>
        
        <div class="iframe-container">
            <span class="iframe-label">Same-Origin iframe</span>
            <div class="smartIframe" 
                 id="test1"
                 data-src="local-form.html"
                 data-allow-resize="true"
                 data-allow-redirect="true"
                 data-allow-events="true"
                 data-debug-mode="true"
                 data-initial-height="400">
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="checkDirectAccess('test1')">Check Direct Access</button>
            <button class="btn btn-secondary" onclick="testResize('test1')">Test Auto-Resize</button>
            <button class="btn btn-warning" onclick="getIframeInfo('test1')">Get iframe Info</button>
        </div>
        
        <div id="status1" class="status-indicator status-waiting">
            <span>‚è≥</span> Initializing same-origin iframe...
        </div>
        
        <div class="console-output" id="console1">
            <div class="console-line console-info">[Same-Origin] Console output will appear here...</div>
        </div>
    </div>

    <!-- Test 2: Local Cross-Origin Simulation -->
    <div class="test-section">
        <div class="test-title">
            <span class="status-icon">‚úÖ</span>
            Test 2: Cross-Origin WITH Helper (Simulated)
        </div>
        <div class="test-description">
            <strong>Testing:</strong> Cross-origin behavior with helper script included.<br>
            <strong>Expected:</strong> PostMessage communication, all events work, no console errors.<br>
            <strong>File:</strong> test-form-with-helper.html (includes iframe-injector.js)
        </div>
        
        <div class="iframe-container">
            <span class="iframe-label">Cross-Origin iframe (With Helper)</span>
            <div class="smartIframe" 
                 id="test2"
                 data-src="test-form-with-helper.html"
                 data-allow-resize="true"
                 data-allow-redirect="true"
                 data-allow-events="true"
                 data-cross-origin="true"
                 data-debug-mode="true"
                 data-initial-height="400">
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="testPostMessage('test2')">Send Test Message</button>
            <button class="btn btn-secondary" onclick="checkCrossOrigin('test2')">Check Cross-Origin Status</button>
            <button class="btn btn-warning" onclick="testFormSubmission('test2')">Simulate Form Submit</button>
        </div>
        
        <div id="status2" class="status-indicator status-waiting">
            <span>‚è≥</span> Waiting for helper script connection...
        </div>
        
        <div class="console-output" id="console2">
            <div class="console-line console-info">[Cross-Origin+Helper] Console output will appear here...</div>
        </div>
    </div>

    <!-- Test 3: Cross-Origin WITHOUT Helper (Fallback) -->
    <div class="test-section">
        <div class="test-title">
            <span class="status-icon">‚ö†Ô∏è</span>
            Test 3: Cross-Origin WITHOUT Helper (Fallback Mode)
        </div>
        <div class="test-description">
            <strong>Testing:</strong> Cross-origin behavior without helper script.<br>
            <strong>Expected:</strong> Limited functionality, graceful fallback, helpful debug messages.<br>
            <strong>File:</strong> test-form-without-helper.html (no iframe-injector.js)
        </div>
        
        <div class="iframe-container">
            <span class="iframe-label">Cross-Origin iframe (No Helper)</span>
            <div class="smartIframe" 
                 id="test3"
                 data-src="test-form-without-helper.html"
                 data-allow-resize="true"
                 data-allow-redirect="true"
                 data-cross-origin="true"
                 data-debug-mode="true"
                 data-initial-height="400">
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="checkFallback('test3')">Check Fallback Mode</button>
            <button class="btn btn-secondary" onclick="testProgressive('test3')">Test Progressive Resize</button>
            <button class="btn btn-warning" onclick="checkLoadCount('test3')">Check Load Count</button>
        </div>
        
        <div id="status3" class="status-indicator status-waiting">
            <span>‚è≥</span> Testing fallback capabilities...
        </div>
        
        <div class="console-output" id="console3">
            <div class="console-line console-info">[Cross-Origin-Fallback] Console output will appear here...</div>
        </div>
    </div>

    <!-- Comparison & Metrics -->
    <div class="test-section">
        <div class="test-title">
            <span class="status-icon">üìä</span>
            Feature Comparison & Metrics
        </div>
        
        <table class="comparison-table">
            <thead>
                <tr>
                    <th>Feature</th>
                    <th>Same-Origin</th>
                    <th>Cross-Origin + Helper</th>
                    <th>Cross-Origin Fallback</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>URL Detection</td>
                    <td>‚úÖ Real-time</td>
                    <td>‚úÖ Via postMessage</td>
                    <td>‚ùå Limited</td>
                </tr>
                <tr>
                    <td>Form Submission</td>
                    <td>‚úÖ Instant</td>
                    <td>‚úÖ Via postMessage</td>
                    <td>‚ö†Ô∏è Load count only</td>
                </tr>
                <tr>
                    <td>Auto-Resize</td>
                    <td>‚úÖ Perfect height</td>
                    <td>‚úÖ Communicated height</td>
                    <td>‚ö†Ô∏è Progressive</td>
                </tr>
                <tr>
                    <td>Validation Detection</td>
                    <td>‚úÖ DOM access</td>
                    <td>‚úÖ Via postMessage</td>
                    <td>‚ö†Ô∏è URL params only</td>
                </tr>
                <tr>
                    <td>Console Errors</td>
                    <td>‚úÖ None</td>
                    <td>‚úÖ None</td>
                    <td>‚úÖ None (v2 improvement)</td>
                </tr>
            </tbody>
        </table>
        
        <div class="info-grid">
            <div class="info-card">
                <h4>üìà Performance Metrics</h4>
                <div class="metric">
                    <span>Load Time:</span>
                    <span class="metric-value" id="load-time">Measuring...</span>
                </div>
                <div class="metric">
                    <span>Memory Usage:</span>
                    <span class="metric-value" id="memory-usage">Calculating...</span>
                </div>
                <div class="metric">
                    <span>Active iframes:</span>
                    <span class="metric-value" id="active-iframes">0</span>
                </div>
                <div class="metric">
                    <span>Messages Received:</span>
                    <span class="metric-value" id="message-count">0</span>
                </div>
            </div>
            
            <div class="info-card">
                <h4>üöÄ v2 Improvements</h4>
                <div class="metric">
                    <span>Console Errors:</span>
                    <span class="metric-value" style="color: #28a745;">0 (v1 had many)</span>
                </div>
                <div class="metric">
                    <span>Cross-Origin Detection:</span>
                    <span class="metric-value" style="color: #28a745;">Automatic</span>
                </div>
                <div class="metric">
                    <span>Fallback Mode:</span>
                    <span class="metric-value" style="color: #28a745;">Graceful</span>
                </div>
                <div class="metric">
                    <span>Debug Information:</span>
                    <span class="metric-value" style="color: #28a745;">Comprehensive</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Smart Iframe v2 -->
    <script src="src/smart-iframe-v2.js"></script>
    
    <script>
        let messageCount = 0;
        let loadStartTime = Date.now();
        
        // Helper function to log to console
        function logToConsole(testId, message, type = 'info') {
            // Map testId to console number based on element ID or UUID pattern
            let consoleNumber;
            if (testId === 'test1') {
                consoleNumber = '1';
            } else if (testId === 'test2') {
                consoleNumber = '2';
            } else if (testId === 'test3') {
                consoleNumber = '3';
            } else {
                // If it's a UUID, try to find which test container it belongs to
                const iframeData = window.smartIframes?.getIframe(testId);
                if (iframeData && iframeData.container) {
                    const containerId = iframeData.container.id;
                    if (containerId === 'test1') consoleNumber = '1';
                    else if (containerId === 'test2') consoleNumber = '2';
                    else if (containerId === 'test3') consoleNumber = '3';
                    else consoleNumber = '1'; // fallback
                } else {
                    consoleNumber = '1'; // fallback
                }
            }
            
            const consoleEl = document.getElementById(`console${consoleNumber}`);
            if (!consoleEl) {
                console.warn('Console element not found for:', testId, 'consoleNumber:', consoleNumber);
                return;
            }
            
            const line = document.createElement('div');
            line.className = `console-line console-${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }
        
        // Update status indicator
        function updateStatus(testId, status, message) {
            // Map testId to status number using same logic as logToConsole
            let statusNumber;
            if (testId === 'test1') {
                statusNumber = '1';
            } else if (testId === 'test2') {
                statusNumber = '2';
            } else if (testId === 'test3') {
                statusNumber = '3';
            } else {
                // If it's a UUID, try to find which test container it belongs to
                const iframeData = window.smartIframes?.getIframe(testId);
                if (iframeData && iframeData.container) {
                    const containerId = iframeData.container.id;
                    if (containerId === 'test1') statusNumber = '1';
                    else if (containerId === 'test2') statusNumber = '2';
                    else if (containerId === 'test3') statusNumber = '3';
                    else statusNumber = '1'; // fallback
                } else {
                    statusNumber = '1'; // fallback
                }
            }
            
            const statusEl = document.getElementById(`status${statusNumber}`);
            const icons = {
                connected: '‚úÖ',
                waiting: '‚è≥',
                error: '‚ùå',
                fallback: '‚ö†Ô∏è'
            };
            statusEl.className = `status-indicator status-${status}`;
            statusEl.innerHTML = `<span>${icons[status]}</span> ${message}`;
        }
        
        // Update metrics
        function updateMetrics() {
            const loadTime = Date.now() - loadStartTime;
            document.getElementById('load-time').textContent = `${loadTime}ms`;
            
            if (window.smartIframes) {
                const allIframes = window.smartIframes.getAllIframes();
                document.getElementById('active-iframes').textContent = allIframes.length;
            }
            
            document.getElementById('message-count').textContent = messageCount;
            
            if (window.performance && window.performance.memory) {
                const memoryMB = Math.round(window.performance.memory.usedJSHeapSize / 1024 / 1024);
                document.getElementById('memory-usage').textContent = `${memoryMB}MB`;
            } else {
                document.getElementById('memory-usage').textContent = 'N/A';
            }
        }
        
        // Set up event listeners
        if (window.smartIframes) {
            // iframe ready
            smartIframes.on('iframe:ready', (data) => {
                const testNum = getTestNumber(data.uuid);
                logToConsole(`test${testNum}`, '‚úÖ iframe is ready!', 'success');
                updateStatus(`test${testNum}`, 'connected', 'Ready and operational');
                updateMetrics();
            });
            
            // URL updates
            smartIframes.on('iframe:url-update', (data) => {
                const testNum = getTestNumber(data.uuid);
                logToConsole(`test${testNum}`, `üîÑ URL updated: ${data.url}`, 'info');
                messageCount++;
                updateMetrics();
            });
            
            // Form submissions
            smartIframes.on('iframe:form-submit', (data) => {
                const testNum = getTestNumber(data.uuid);
                logToConsole(`test${testNum}`, `üìù Form submitted: ${data.formId}`, 'info');
                messageCount++;
                updateMetrics();
            });
            
            // Validation errors
            smartIframes.on('iframe:validation-error', (data) => {
                const testNum = getTestNumber(data.uuid);
                logToConsole(`test${testNum}`, `‚ùå Validation error detected`, 'error');
                messageCount++;
                updateMetrics();
            });
            
            // Cross-origin detection
            smartIframes.on('iframe:cross-origin-detected', (data) => {
                const testNum = getTestNumber(data.uuid);
                logToConsole(`test${testNum}`, 'üåê Cross-origin iframe detected', 'warning');
                if (testNum === '1') {
                    logToConsole(`test${testNum}`, '‚ö†Ô∏è Unexpected: Test 1 should be same-origin', 'error');
                }
            });
            
            // Message received (helper script working)
            smartIframes.on('iframe:message-received', (data) => {
                const testNum = getTestNumber(data.uuid);
                logToConsole(`test${testNum}`, 'üì® Helper script communication active', 'success');
                updateStatus(`test${testNum}`, 'connected', 'Helper script detected!');
                messageCount++;
                updateMetrics();
            });
            
            // Possible navigation (fallback mode)
            smartIframes.on('iframe:possible-navigation', (data) => {
                const testNum = getTestNumber(data.uuid);
                logToConsole(`test${testNum}`, `üîÑ Possible navigation (load #${data.loadCount})`, 'warning');
                if (testNum === '3') {
                    updateStatus(`test${testNum}`, 'fallback', 'Fallback mode active');
                }
            });
            
            // Resize events
            smartIframes.on('iframe:resize', (data) => {
                const testNum = getTestNumber(data.uuid);
                const method = data.method ? ` (${data.method})` : '';
                logToConsole(`test${testNum}`, `üìè Resized to ${data.height}px${method}`, 'info');
            });
        }
        
        function getTestNumber(uuid) {
            if (uuid.includes('test1')) return '1';
            if (uuid.includes('test2')) return '2';
            if (uuid.includes('test3')) return '3';
            return '?';
        }
        
        // Test functions
        function checkDirectAccess(testId) {
            if (!window.smartIframes) return;
            
            const iframeData = window.smartIframes.getIframe(testId);
            if (!iframeData) {
                logToConsole(testId, '‚ùå iframe not found', 'error');
                return;
            }
            
            try {
                const iframe = iframeData.iframe;
                const url = iframe.contentWindow.location.href;
                const title = iframe.contentDocument.title;
                const height = iframe.contentDocument.body.scrollHeight;
                
                logToConsole(testId, `‚úÖ Direct access successful!`, 'success');
                logToConsole(testId, `URL: ${url}`, 'info');
                logToConsole(testId, `Title: ${title}`, 'info');
                logToConsole(testId, `Height: ${height}px`, 'info');
            } catch (e) {
                logToConsole(testId, `‚ùå Cannot access: ${e.message}`, 'error');
                logToConsole(testId, `This might be cross-origin or blocked`, 'warning');
            }
        }
        
        function testResize(testId) {
            if (!window.smartIframes) return;
            
            logToConsole(testId, 'üìè Testing resize functionality...', 'info');
            const iframeData = window.smartIframes.getIframe(testId);
            if (iframeData) {
                const iframe = iframeData.iframe;
                const currentHeight = parseInt(iframe.style.height);
                const newHeight = currentHeight + 100;
                iframe.style.height = `${newHeight}px`;
                logToConsole(testId, `üìè Manually resized to ${newHeight}px`, 'success');
            }
        }
        
        function getIframeInfo(testId) {
            if (!window.smartIframes) return;
            
            const iframeData = window.smartIframes.getIframe(testId);
            if (!iframeData) {
                logToConsole(testId, '‚ùå iframe not found', 'error');
                return;
            }
            
            logToConsole(testId, `üìä iframe Information:`, 'info');
            logToConsole(testId, `Cross-origin: ${iframeData.isCrossOrigin}`, 'info');
            logToConsole(testId, `Ready: ${iframeData.isReady}`, 'info');
            logToConsole(testId, `Message received: ${iframeData.messageReceived}`, 'info');
            logToConsole(testId, `Last known URL: ${iframeData.lastKnownUrl}`, 'info');
        }
        
        function testPostMessage(testId) {
            if (!window.smartIframes) {
                logToConsole(testId, '‚ùå window.smartIframes not available', 'error');
                return;
            }
            
            // Debug: Check what iframes we have
            const allIframes = window.smartIframes.getAllIframes();
            console.log('All available iframes:', allIframes);
            console.log('Container IDs:', allIframes.map(data => ({ uuid: data.uuid, containerId: data.container?.id })));
            logToConsole(testId, `üìä Available iframes: ${allIframes.length}`, 'info');
            
            // Debug: Try to get the iframe
            const iframeData = window.smartIframes.getIframe(testId);
            console.log('Getting iframe for testId:', testId, 'Result:', iframeData);
            
            logToConsole(testId, 'üì® Sending test message to iframe...', 'info');
            const success = window.smartIframes.sendToIframe(testId, 'TEST_MESSAGE', {
                message: 'Hello from parent test!',
                timestamp: Date.now(),
                test: 'functionality'
            });
            
            if (success) {
                logToConsole(testId, '‚úÖ Message sent successfully', 'success');
            } else {
                logToConsole(testId, '‚ùå Failed to send message', 'error');
            }
        }
        
        function checkCrossOrigin(testId) {
            if (!window.smartIframes) return;
            
            const iframeData = window.smartIframes.getIframe(testId);
            if (!iframeData) {
                logToConsole(testId, '‚ùå iframe not found', 'error');
                return;
            }
            
            logToConsole(testId, `üåê Cross-origin status check:`, 'info');
            logToConsole(testId, `Is cross-origin: ${iframeData.isCrossOrigin}`, 'info');
            logToConsole(testId, `Helper communication: ${iframeData.messageReceived ? 'Active' : 'None'}`, 
                        iframeData.messageReceived ? 'success' : 'warning');
            
            if (!iframeData.messageReceived) {
                logToConsole(testId, '‚ö†Ô∏è Helper script may not be working', 'warning');
            }
        }
        
        function testFormSubmission(testId) {
            logToConsole(testId, 'üìù Form submission test - check iframe for form actions', 'info');
            logToConsole(testId, 'üí° Click buttons in the iframe to test form submission detection', 'info');
        }
        
        function checkFallback(testId) {
            if (!window.smartIframes) return;
            
            const iframeData = window.smartIframes.getIframe(testId);
            if (!iframeData) {
                logToConsole(testId, '‚ùå iframe not found', 'error');
                return;
            }
            
            logToConsole(testId, 'üîç Fallback mode status:', 'info');
            logToConsole(testId, `Cross-origin: ${iframeData.isCrossOrigin}`, 'info');
            logToConsole(testId, `Helper script: ${iframeData.messageReceived ? 'Detected' : 'Not detected'}`, 
                        iframeData.messageReceived ? 'success' : 'warning');
            
            if (iframeData.isCrossOrigin && !iframeData.messageReceived) {
                logToConsole(testId, '‚úÖ Fallback mode is active', 'warning');
                logToConsole(testId, 'Features: Load counting, progressive resize, URL params', 'info');
                updateStatus(testId, 'fallback', 'Fallback mode active');
            }
        }
        
        function testProgressive(testId) {
            logToConsole(testId, 'üìè Testing progressive resize...', 'info');
            logToConsole(testId, 'üí° Click "Add Content" buttons in iframe to see progressive resize', 'info');
        }
        
        function checkLoadCount(testId) {
            logToConsole(testId, 'üî¢ Load count tracking active', 'info');
            logToConsole(testId, 'üí° Navigation in iframe will increment load count', 'info');
        }
        
        // Initialize
        setTimeout(() => {
            logToConsole('test1', 'Same-origin iframe initialized', 'info');
            logToConsole('test2', 'Cross-origin iframe (with helper) initialized', 'info');
            logToConsole('test3', 'Cross-origin iframe (fallback) initialized', 'info');
            updateMetrics();
            
            // Set up periodic metrics update
            setInterval(updateMetrics, 2000);
        }, 1000);
    </script>
</body>
</html>