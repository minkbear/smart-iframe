class SmartIframeLoader{constructor(){this.iframes=new Map,this.events=new Map,this.messageTypes={RESIZE:"resize",REDIRECT:"redirect",EVENT:"event",READY:"ready",CONFIG:"config",ERROR:"error",URL_UPDATE:"url_update",FORM_SUBMIT:"form_submit",VALIDATION_ERROR:"validation_error"},this.init()}init(){console.log("Smart Iframe v2: Initializing..."),window.addEventListener("message",this.handleMessage.bind(this)),"loading"===document.readyState?(console.log("Smart Iframe v2: DOM not ready, waiting for DOMContentLoaded"),document.addEventListener("DOMContentLoaded",this.autoDetect.bind(this))):(console.log("Smart Iframe v2: DOM ready, starting auto-detect immediately"),this.autoDetect()),this.observeDOM()}autoDetect(){console.log("Smart Iframe v2: Starting auto-detection...");const e=document.querySelectorAll("[data-smart-iframe]");console.log(`Smart Iframe v2: Found ${e.length} elements with [data-smart-iframe]`),e.forEach(e=>{console.log("Smart Iframe v2: Checking element:",e,"ID:",e.id);if(e.querySelector("iframe"))return void console.log("Smart Iframe v2: Element already has iframe, skipping");e.id&&this.iframes.has(e.id)?console.log("Smart Iframe v2: Element already processed, skipping"):(console.log("Smart Iframe v2: Creating smart iframe for element"),this.createSmartIframe(e))});const t=document.querySelectorAll(".smartIframe[data-src]");console.log(`Smart Iframe v2: Found ${t.length} elements with .smartIframe[data-src]`),t.forEach(e=>{console.log("Smart Iframe v2: Checking simple element:",e,"ID:",e.id);if(e.querySelector("iframe"))return void console.log("Smart Iframe v2: Element already has iframe, skipping");e.id&&this.iframes.has(e.id)?console.log("Smart Iframe v2: Element already processed, skipping"):(console.log("Smart Iframe v2: Creating simple iframe for element"),this.createSimpleIframe(e))}),console.log("Smart Iframe v2: Auto-detection completed")}isCrossOrigin(e){try{const t=new URL(e),r=new URL(window.location.href);return t.origin!==r.origin}catch{return!0}}createSmartIframe(e){const t=this.parseConfig(e),r=this.generateUUID();console.log(`Smart Iframe: Creating smart iframe with UUID: ${r}`),console.log(`Smart Iframe: Config src: ${t.src}`);const i=this.buildIframe(t,r);return t.isCrossOrigin=this.isCrossOrigin(t.src),e.id||(e.id=r),e.appendChild(i),this.iframes.set(r,{container:e,iframe:i,config:t,isReady:!1,isCrossOrigin:t.isCrossOrigin,lastKnownUrl:t.src,messageReceived:!1,formSubmitted:!1}),this.addStyles(),i.addEventListener("load",()=>{this.handleIframeLoad(r)}),r}createSimpleIframe(e){const t=e.dataset;console.log("Smart Iframe: Creating simple iframe from container:",e);const r={src:t.src,allowResize:"false"!==t.resize,allowRedirect:"false"!==t.redirect,allowEvents:"false"!==t.events,maxHeight:parseInt(t.maxHeight)||parseInt(t.max)||9e3,minHeight:parseInt(t.minHeight)||parseInt(t.min)||400,initialHeight:parseInt(t.height)||parseInt(t.initialHeight)||800,scrolling:t.scrolling||"no",sandbox:t.sandbox||"allow-scripts allow-same-origin allow-forms",title:t.title||"Smart Iframe",validationDetection:t.validationDetection||"auto",successPatterns:t.successPatterns?t.successPatterns.split(","):["/success","/thank","/complete","/done"],errorPatterns:t.errorPatterns?t.errorPatterns.split(","):["same-url","/error","/invalid"],confirmOnUncertain:"false"!==t.confirmOnUncertain,debugMode:"true"===t.debugMode||"debug"===t.validationDetection,laravelMode:"true"===t.laravelMode,errorParams:t.errorParams?t.errorParams.split(","):["validation_status=error","errors=1","error=1"],successParams:t.successParams?t.successParams.split(","):["status=success","success=1"],validationTiming:parseInt(t.validationTiming)||500,crossOrigin:"true"===t.crossOrigin},i=this.generateUUID();console.log(`Smart Iframe: Generated UUID for simple iframe: ${i}`),console.log(`Smart Iframe: Simple iframe src: ${r.src}`);const a=this.buildIframe(r,i);return r.isCrossOrigin=this.isCrossOrigin(r.src),e.id||(e.id=i),e.appendChild(a),this.iframes.set(i,{container:e,iframe:a,config:r,isReady:!1,isCrossOrigin:r.isCrossOrigin,lastKnownUrl:r.src,messageReceived:!1,formSubmitted:!1}),this.addStyles(),a.addEventListener("load",()=>{this.handleIframeLoad(i)}),i}handleIframeLoad(e){const t=this.iframes.get(e);if(!t)return;const{config:r,iframe:i,isCrossOrigin:a}=t;this.sendConfig(e,r),a?(console.log(`Smart Iframe: Cross-origin detected for ${e}. Waiting for postMessage communication...`),this.setupCrossOriginFallback(e)):this.tryDirectAccess(e),this.tryAutoResize(e,r),this.setReadyWithFallback(e)}tryDirectAccess(e){const t=this.iframes.get(e);if(!t)return;const{iframe:r}=t;try{const i=r.contentWindow.location.href;t.lastKnownUrl=i,this.setupSameOriginMonitoring(e)}catch(r){console.log(`Smart Iframe: Cannot access iframe URL for ${e}. Treating as cross-origin.`),t.isCrossOrigin=!0,this.setupCrossOriginFallback(e)}}setupSameOriginMonitoring(e){const t=this.iframes.get(e);if(!t)return;const{iframe:r,config:i}=t;let a=t.lastKnownUrl;const s=setInterval(()=>{try{const i=r.contentWindow.location.href;i!==a&&(this.handleUrlChange(e,i,a),a=i,t.lastKnownUrl=i)}catch(r){clearInterval(s),t.isCrossOrigin=!0,this.setupCrossOriginFallback(e)}},500);t.monitoringInterval=s}setupCrossOriginFallback(e){const t=this.iframes.get(e);if(!t)return;const{iframe:r,config:i}=t;setTimeout(()=>{t.messageReceived||(console.warn(`Smart Iframe: No postMessage received from ${e}. Helper script may not be installed.`),i.debugMode&&this.showDebugInfo(e,{status:"No Communication",reason:"iframe-injector.js not detected",suggestion:"Add iframe-injector.js to iframe page for full functionality",fallbackMode:"limited"}),this.setupLimitedFallback(e))},3e3)}setupLimitedFallback(e){const t=this.iframes.get(e);if(!t)return;const{iframe:r,config:i}=t;let a=0;r.addEventListener("load",()=>{if(a++,a>1&&(this.triggerEvent("iframe:possible-navigation",{uuid:e,loadCount:a,timestamp:Date.now()}),i.allowRedirect&&a>2)){const t=this.extractRedirectUrl(r.src);t&&this.handleDetectedRedirect(e,t)}}),i.allowResize&&this.setupProgressiveResize(e,i)}parseConfig(e){const t=e.dataset;return{src:t.smartIframe,allowResize:"false"!==t.allowResize,allowRedirect:"false"!==t.allowRedirect,allowEvents:"false"!==t.allowEvents,maxHeight:parseInt(t.maxHeight)||null,minHeight:parseInt(t.minHeight)||200,initialHeight:parseInt(t.initialHeight)||200,scrolling:t.scrolling||"no",sandbox:t.sandbox||"allow-scripts allow-same-origin allow-forms",title:t.title||"Smart Iframe",validationDetection:t.validationDetection||"auto",successPatterns:t.successPatterns?t.successPatterns.split(","):["/success","/thank","/complete","/done"],errorPatterns:t.errorPatterns?t.errorPatterns.split(","):["same-url","/error","/invalid"],confirmOnUncertain:"false"!==t.confirmOnUncertain,debugMode:"true"===t.debugMode||"debug"===t.validationDetection,laravelMode:"true"===t.laravelMode,errorParams:t.errorParams?t.errorParams.split(","):["validation_status=error","errors=1","error=1"],successParams:t.successParams?t.successParams.split(","):["status=success","success=1"],validationTiming:parseInt(t.validationTiming)||500,crossOrigin:"true"===t.crossOrigin}}buildIframe(e,t){const r=document.createElement("iframe");let i=e.src;if(t){const e=i.includes("?")?"&":"?";i+=`${e}uuid=${t}`,console.log(`Smart Iframe: Building iframe with UUID: ${t}, final URL: ${i}`)}else console.warn("Smart Iframe: No UUID provided to buildIframe");if(r.src=i,r.scrolling=e.scrolling,r.title=e.title,r.className="smart-iframe",e.sandbox){let t=e.sandbox;e.allowRedirect&&!t.includes("allow-top-navigation")&&(t+=" allow-top-navigation-by-user-activation"),r.sandbox=t}return r.style.height=`${e.initialHeight}px`,r.setAttribute("loading","lazy"),r.setAttribute("referrerpolicy","strict-origin-when-cross-origin"),r}sendConfig(e,t){const r=this.iframes.get(e);if(!r)return;const i={type:this.messageTypes.CONFIG,uuid:e,config:{parentUrl:window.location.href,allowResize:t.allowResize,allowRedirect:t.allowRedirect,allowEvents:t.allowEvents}};r.iframe.contentWindow?.postMessage(i,"*")}handleMessage(e){if(!e.data||!e.data.type||!e.data.uuid)return;const{type:t,uuid:r}=e.data,i=this.iframes.get(r);if(i)switch(i.messageReceived=!0,t){case"IFRAME_URL_UPDATE":this.handleUrlUpdateMessage(r,e.data);break;case"FORM_SUBMIT":this.handleFormSubmitMessage(r,e.data);break;case"VALIDATION_ERROR_DETECTED":this.handleValidationErrorMessage(r,e.data);break;case this.messageTypes.RESIZE:this.handleResizeMessage(r,e.data.payload);break;case this.messageTypes.REDIRECT:this.handleRedirectMessage(r,e.data.payload);break;case this.messageTypes.READY:this.handleReadyMessage(r);break;case this.messageTypes.EVENT:this.handleEventMessage(r,e.data.payload)}}handleUrlUpdateMessage(e,t){const r=this.iframes.get(e);if(!r)return;const{url:i,pathname:a,search:s}=t,n=r.lastKnownUrl,o=n&&n!==i;if(r.lastKnownUrl=i,this.triggerEvent("iframe:url-update",{uuid:e,url:i,pathname:a,search:s,oldUrl:n,timestamp:t.timestamp}),r.config.laravelMode&&this.checkLaravelValidation(e,i),r.config.allowRedirect&&o){const t=r.config.src,a=this.extractRedirectUrl(t);let s=!1;if(a)try{const e=new URL(a),t=new URL(i);(i===a||t.pathname===e.pathname||i.includes(e.hostname)||e.pathname.includes("thank-you")&&i.includes("thank-you"))&&(s=!0)}catch(e){console.warn("Error parsing URLs for redirect match:",e)}a&&(r.formSubmitted||s)?(console.log("Smart Iframe: Redirect detected via URL change:",{current:i,previous:n,expected:a,formSubmitted:r.formSubmitted,isRedirectMatch:s,trigger:r.formSubmitted?"form_submitted":"redirect_url_match"}),this.performRedirect(e,a)):console.log("Smart Iframe: URL changed but no redirect conditions met:",{url:i,previous:n,formSubmitted:r.formSubmitted,isRedirectMatch:s,hasRedirectUrl:!!a,expectedRedirectUrl:a})}else r.config.allowRedirect&&!o&&console.log("Smart Iframe: Initial URL load (no redirect check):",{url:i,isInitialLoad:!0})}handleFormSubmitMessage(e,t){const r=this.iframes.get(e);r&&(r.formSubmitted=!0,r.formSubmitTime=t.timestamp,this.triggerEvent("iframe:form-submit",{uuid:e,formId:t.formId,method:t.method,action:t.action,timestamp:t.timestamp}))}handleValidationErrorMessage(e,t){this.triggerEvent("iframe:validation-error",{uuid:e,url:t.url,hasErrors:t.hasErrors,timestamp:t.timestamp})}handleResizeMessage(e,t){const r=this.iframes.get(e);if(!r||!r.config.allowResize)return;const{height:i,width:a}=t,{iframe:s,config:n}=r;if(i){let e=Math.max(i,n.minHeight);n.maxHeight&&(e=Math.min(e,n.maxHeight)),s.style.height=`${e}px`}a&&(s.style.width=`${a}px`),this.triggerEvent("iframe:resize",{uuid:e,height:i,width:a})}handleRedirectMessage(e,t){const r=this.iframes.get(e);if(!r||!r.config.allowRedirect)return;const{url:i,target:a="_self"}=t;this.isValidUrl(i)&&("_parent"===a||"_top"===a?window.open(i,a):window.location.href=i,this.triggerEvent("iframe:redirect",{uuid:e,url:i,target:a}))}handleReadyMessage(e){const t=this.iframes.get(e);t&&(t.isReady=!0,this.triggerEvent("iframe:ready",{uuid:e}))}handleEventMessage(e,t){const r=this.iframes.get(e);if(!r||!r.config.allowEvents)return;const{eventName:i,data:a}=t;this.triggerEvent(`iframe:${i}`,{uuid:e,data:a})}handleUrlChange(e,t,r){this.triggerEvent("iframe:url-change",{uuid:e,newUrl:t,oldUrl:r,timestamp:Date.now()});const i=this.iframes.get(e);i&&i.config.laravelMode&&this.checkLaravelValidation(e,t)}checkLaravelValidation(e,t){const r=this.iframes.get(e);if(!r)return;const{config:i}=r;try{const r=new URL(t).searchParams;for(const a of i.errorParams)if(a.includes("=")){const[i,s]=a.split("=");if(r.get(i)===s)return void this.triggerEvent("iframe:validation-error",{uuid:e,url:t,errorParam:a,timestamp:Date.now()})}else if(r.has(a))return void this.triggerEvent("iframe:validation-error",{uuid:e,url:t,errorParam:a,timestamp:Date.now()});for(const a of i.successParams)if(a.includes("=")){const[i,s]=a.split("=");if(r.get(i)===s)return void this.triggerEvent("iframe:form-success",{uuid:e,url:t,successParam:a,timestamp:Date.now()})}else if(r.has(a))return void this.triggerEvent("iframe:form-success",{uuid:e,url:t,successParam:a,timestamp:Date.now()})}catch(e){console.error("Error checking Laravel validation:",e)}}handleDetectedRedirect(e,t){const r=this.iframes.get(e);r&&r.config.allowRedirect&&this.isValidUrl(t)&&(window.location.href=t,this.triggerEvent("iframe:redirect",{uuid:e,url:t,detected:!0,timestamp:Date.now()}))}performRedirect(e,t){const r=this.iframes.get(e);r&&r.config.allowRedirect&&this.isValidUrl(t)&&(console.log("Smart Iframe: Performing redirect to:",t),window.location.href=t,this.triggerEvent("iframe:redirect",{uuid:e,url:t,detected:!0,auto:!0,timestamp:Date.now()}))}tryAutoResize(e,t){if(!t.allowResize)return;const r=this.iframes.get(e);if(!r)return;const{iframe:i,isCrossOrigin:a}=r;if(a)this.setupProgressiveResize(e,t);else try{const r=i.contentDocument?.body?.scrollHeight;if(r&&r>t.initialHeight){let a=Math.max(r,t.minHeight);t.maxHeight&&(a=Math.min(a,t.maxHeight)),i.style.height=`${a}px`,this.triggerEvent("iframe:resize",{uuid:e,height:a,auto:!0})}}catch(r){this.setupProgressiveResize(e,t)}}setupProgressiveResize(e,t){const r=this.iframes.get(e);if(!r)return;const{iframe:i}=r;let a=t.initialHeight;const s=t.maxHeight||Math.min(.8*window.innerHeight,1200);let n=0;const o=()=>{n>=20||(n++,a=Math.min(a+100,s),i.style.height=`${a}px`,this.triggerEvent("iframe:resize",{uuid:e,height:a,auto:!0,method:"progressive"}),a<s&&setTimeout(o,1500))};setTimeout(o,2e3)}setReadyWithFallback(e){const t=this.iframes.get(e);t&&setTimeout(()=>{t.isReady||(t.isReady=!0,this.triggerEvent("iframe:ready",{uuid:e,fallback:!0}))},3e3)}extractRedirectUrl(e){try{const t=new URL(e),r=t.searchParams.get("redirect")||t.searchParams.get("return")||t.searchParams.get("p");return r?decodeURIComponent(r):null}catch{return null}}showDebugInfo(e,t){const r=["🔍 Smart Iframe Debug Info",`UUID: ${e}`,`Status: ${t.status}`,`Reason: ${t.reason}`,t.suggestion?`💡 Suggestion: ${t.suggestion}`:"",t.fallbackMode?`Mode: ${t.fallbackMode}`:""].filter(Boolean).join("\n");console.log(r),confirm(r+"\n\nShow documentation?")&&window.open("https://github.com/your-repo/smart-iframe/blob/main/CROSS-ORIGIN-SETUP.md","_blank")}isValidUrl(e){try{const t=new URL(e);return["http:","https:"].includes(t.protocol)}catch{return!1}}on(e,t){return this.events.has(e)||this.events.set(e,new Set),this.events.get(e).add(t),()=>{this.events.get(e)?.delete(t)}}triggerEvent(e,t){const r=this.events.get(e);r&&r.forEach(r=>{try{r(t)}catch(t){console.error(`Error in event callback for ${e}:`,t)}})}sendToIframe(e,t,r){const i=this.iframes.get(e);if(!i)return!1;const a={type:t,uuid:e,payload:r};return i.iframe.contentWindow?.postMessage(a,"*"),!0}removeIframe(e){const t=this.iframes.get(e);t&&(t.monitoringInterval&&clearInterval(t.monitoringInterval),t.container.removeChild(t.iframe),this.iframes.delete(e),this.triggerEvent("iframe:removed",{uuid:e}))}observeDOM(){if(!window.MutationObserver)return;new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(1===e.nodeType){e.hasAttribute("data-smart-iframe")&&this.createSmartIframe(e),e.classList?.contains("smartIframe")&&e.hasAttribute("data-src")&&this.createSimpleIframe(e);const t=e.querySelectorAll?.("[data-smart-iframe]");t?.forEach(e=>{e.id||this.createSmartIframe(e)});const r=e.querySelectorAll?.(".smartIframe[data-src]");r?.forEach(e=>{e.id||this.createSimpleIframe(e)})}})})}).observe(document.body,{childList:!0,subtree:!0})}addStyles(){if(document.getElementById("smart-iframe-styles"))return;const e=document.createElement("style");e.id="smart-iframe-styles",e.textContent="\n            .smart-iframe-container {\n                width: 100%;\n                position: relative;\n                overflow: hidden;\n            }\n            \n            .smart-iframe {\n                border: none;\n                width: 100%;\n                height: 200px;\n                display: block;\n                transition: height 0.3s ease;\n            }\n            \n            .smart-iframe.loading {\n                opacity: 0.7;\n            }\n            \n            .smart-iframe.error {\n                border: 2px solid #ff6b6b;\n                background: #ffe6e6;\n            }\n        ",document.head.appendChild(e)}generateUUID(){return"iframe_"+Math.random().toString(36).substring(2,11)+Date.now().toString(36)}getIframe(e){if(this.iframes.has(e))return this.iframes.get(e);for(const[t,r]of this.iframes.entries())if(r.container&&r.container.id===e)return r;return null}getAllIframes(){return Array.from(this.iframes.entries()).map(([e,t])=>({uuid:e,...t}))}sendToIframe(e,t,r){const i=this.getIframe(e);if(!i||!i.iframe)return this.debugMode&&console.log("Smart Iframe: Cannot send message - iframe not found:",e),!1;try{const a={type:t,data:r,uuid:i.uuid,timestamp:Date.now()};return i.iframe.contentWindow.postMessage(a,"*"),this.debugMode&&console.log("Smart Iframe: Message sent to iframe:",e,a),!0}catch(e){return this.debugMode&&console.log("Smart Iframe: Failed to send message:",e),!1}}}"undefined"!=typeof window&&(window.SmartIframeLoader=SmartIframeLoader,window.smartIframes=new SmartIframeLoader);