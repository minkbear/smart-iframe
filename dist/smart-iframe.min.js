class SmartIframeLoader{constructor(){this.iframes=new Map,this.events=new Map,this.messageTypes={RESIZE:"resize",REDIRECT:"redirect",EVENT:"event",READY:"ready",CONFIG:"config",ERROR:"error"},this.init()}init(){window.addEventListener("message",this.handleMessage.bind(this)),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",this.autoDetect.bind(this)):this.autoDetect(),this.observeDOM()}autoDetect(){document.querySelectorAll("[data-smart-iframe]").forEach(e=>{e.id||this.createSmartIframe(e)});document.querySelectorAll(".smartIframe[data-src]").forEach(e=>{e.id||this.createSimpleIframe(e)})}createSmartIframe(e){const t=this.parseConfig(e),i=this.buildIframe(t),r=this.generateUUID();return e.id=r,e.appendChild(i),this.iframes.set(r,{container:e,iframe:i,config:t,isReady:!1}),this.addStyles(),i.addEventListener("load",()=>{this.sendConfig(r,t),this.tryAutoResize(r,t),this.startUrlMonitoring(r,t),this.setReadyWithFallback(r)}),r}createSimpleIframe(e){const t=e.dataset,i={src:t.src,allowResize:"false"!==t.resize,allowRedirect:"false"!==t.redirect,allowEvents:"false"!==t.events,maxHeight:parseInt(t.maxHeight)||parseInt(t.max)||9e3,minHeight:parseInt(t.minHeight)||parseInt(t.min)||400,initialHeight:parseInt(t.height)||parseInt(t.initialHeight)||800,scrolling:t.scrolling||"no",sandbox:t.sandbox||"allow-scripts allow-same-origin allow-forms",title:t.title||"Smart Iframe"},r=this.buildIframe(i),s=this.generateUUID();return e.id=s,e.appendChild(r),this.iframes.set(s,{container:e,iframe:r,config:i,isReady:!1}),this.addStyles(),r.addEventListener("load",()=>{this.sendConfig(s,i),this.tryAutoResize(s,i),this.startUrlMonitoring(s,i),this.setReadyWithFallback(s)}),s}parseConfig(e){const t=e.dataset;return{src:t.smartIframe,allowResize:"false"!==t.allowResize,allowRedirect:"false"!==t.allowRedirect,allowEvents:"false"!==t.allowEvents,maxHeight:parseInt(t.maxHeight)||null,minHeight:parseInt(t.minHeight)||200,initialHeight:parseInt(t.initialHeight)||200,scrolling:t.scrolling||"no",sandbox:t.sandbox||"allow-scripts allow-same-origin allow-forms",title:t.title||"Smart Iframe"}}buildIframe(e){const t=document.createElement("iframe");return t.src=e.src,t.scrolling=e.scrolling,t.title=e.title,t.className="smart-iframe",e.sandbox&&(t.sandbox=e.sandbox),t.style.height=`${e.initialHeight}px`,t.setAttribute("loading","lazy"),t.setAttribute("referrerpolicy","strict-origin-when-cross-origin"),t}sendConfig(e,t){const i=this.iframes.get(e);if(!i)return;const r={type:this.messageTypes.CONFIG,uuid:e,config:{parentUrl:window.location.href,allowResize:t.allowResize,allowRedirect:t.allowRedirect,allowEvents:t.allowEvents}};i.iframe.contentWindow?.postMessage(r,"*")}tryAutoResize(e,t){if(!t.allowResize)return;const i=this.iframes.get(e);if(!i)return;const{iframe:r}=i;try{const i=r.contentDocument?.body?.scrollHeight;if(i&&i>t.initialHeight){let s=Math.max(i,t.minHeight);t.maxHeight&&(s=Math.min(s,t.maxHeight)),r.style.height=`${s}px`,this.triggerEvent("iframe:resize",{uuid:e,height:s,auto:!0})}}catch(i){this.setupScrollDetection(e,t)}}setupScrollDetection(e,t){const i=this.iframes.get(e);if(!i)return;const{iframe:r}=i;this.setupProgressiveResize(e,t),this.setupIntersectionResize(e,t),this.setupScrollBasedResize(e,t)}setupProgressiveResize(e,t){const i=this.iframes.get(e);if(!i)return;const{iframe:r}=i;let s=t.initialHeight;const n=t.maxHeight||Math.min(.8*window.innerHeight,1200);let a=0;const o=()=>{a>=20||(a++,s=Math.min(s+100,n),r.style.height=`${s}px`,this.triggerEvent("iframe:resize",{uuid:e,height:s,auto:!0,method:"progressive"}),s<n&&setTimeout(o,1500))};setTimeout(o,2e3)}setupIntersectionResize(e,t){if(!window.IntersectionObserver)return;const i=this.iframes.get(e);if(!i)return;const{iframe:r}=i,s=new IntersectionObserver(i=>{i.forEach(i=>{if(i.isIntersecting){const i=window.innerHeight,s=Math.min(.7*i,t.maxHeight||1e3);s>parseInt(r.style.height)&&(r.style.height=`${s}px`,this.triggerEvent("iframe:resize",{uuid:e,height:s,auto:!0,method:"intersection"}))}})},{threshold:.1});s.observe(r),i.intersectionObserver=s}setupScrollBasedResize(e,t){const i=this.iframes.get(e);if(!i)return;const{iframe:r}=i;["mouseenter","mouseover","focus","click"].forEach(i=>{r.addEventListener(i,()=>{const s=parseInt(r.style.height),n=t.maxHeight||Math.min(.9*window.innerHeight,1200);if(s<n){const t=Math.min(s+200,n);r.style.height=`${t}px`,this.triggerEvent("iframe:resize",{uuid:e,height:t,auto:!0,method:"event-based",trigger:i})}},{once:!0})})}setReadyWithFallback(e){const t=this.iframes.get(e);t&&setTimeout(()=>{t.isReady||this.handleReady(e,t)},3e3)}startUrlMonitoring(e,t){if(!t.allowRedirect)return;const i=this.iframes.get(e);if(!i)return;const{iframe:r}=i;let s=r.src;i.monitoring={originalSrc:s,redirectCount:0,lastActivity:Date.now()},this.setupNavigationDetection(e),this.setupLoadEventMonitoring(e),this.setupPerformanceMonitoring(e)}setupNavigationDetection(e){const t=this.iframes.get(e);if(!t)return;const{iframe:i}=t,r=()=>{t.monitoring.redirectCount++,t.monitoring.lastActivity=Date.now(),this.triggerEvent("iframe:navigation-detected",{uuid:e,timestamp:Date.now(),redirectCount:t.monitoring.redirectCount});const i=this.extractRedirectUrl(t.monitoring.originalSrc);this.handleDetectedRedirect(e,i||"cross-origin-navigation",t.monitoring.originalSrc)};i.addEventListener("load",r),t.loadHandler=r}setupLoadEventMonitoring(e){const t=this.iframes.get(e);if(!t)return;const{iframe:i}=t;let r=0;const s=i.onload;i.onload=n=>{r++,r>1&&this.triggerEvent("iframe:redirect-detected",{uuid:e,newUrl:"cross-origin-redirect",oldUrl:t.monitoring.originalSrc,redirectCount:r-1,method:"load-event"}),s&&s.call(i,n)}}setupPerformanceMonitoring(e){if(!window.PerformanceObserver)return;const t=this.iframes.get(e);if(t)try{const e=new PerformanceObserver(e=>{e.getEntries().forEach(e=>{e.entryType})});e.observe({entryTypes:["navigation"]}),t.performanceObserver=e}catch(e){}}extractRedirectUrl(e){try{const t=new URL(e).searchParams.get("redirect");return t?decodeURIComponent(t):null}catch{return null}}handleDetectedRedirect(e,t,i){const r=this.iframes.get(e);r?.config.allowRedirect&&(this.triggerEvent("iframe:redirect-detected",{uuid:e,newUrl:t,oldUrl:i,redirectCount:r.monitoring?.redirectCount||0}),t&&"cross-origin-navigation"!==t&&this.isValidUrl(t)&&(window.location.href=t,this.triggerEvent("iframe:redirect",{uuid:e,url:t,target:"_self",detected:!0,auto:!0})))}shouldAllowAutoRedirect(e,t){try{const i=new URL(e),r=new URL(t);return i.hostname===r.hostname}catch{return!1}}handleMessage(e){if(!this.isValidMessage(e))return;const{type:t,uuid:i,payload:r}=e.data,s=this.iframes.get(i);if(s)switch(t){case this.messageTypes.READY:this.handleReady(i,s);break;case this.messageTypes.RESIZE:this.handleResize(i,s,r);break;case this.messageTypes.REDIRECT:this.handleRedirect(i,s,r);break;case this.messageTypes.EVENT:this.handleEvent(i,s,r);break;case this.messageTypes.ERROR:this.handleError(i,s,r)}}isValidMessage(e){try{const{type:t,uuid:i}=e.data;return t&&i&&this.iframes.has(i)}catch{return!1}}handleReady(e,t){t.isReady||(t.isReady=!0,this.triggerEvent("iframe:ready",{uuid:e,iframe:t}))}handleResize(e,t,i){if(!t.config.allowResize)return;const{height:r,width:s}=i,{iframe:n,config:a}=t;if(r){let e=Math.max(r,a.minHeight);a.maxHeight&&(e=Math.min(e,a.maxHeight)),n.style.height=`${e}px`}s&&(n.style.width=`${s}px`),this.triggerEvent("iframe:resize",{uuid:e,height:r,width:s})}handleRedirect(e,t,i){if(!t.config.allowRedirect)return;const{url:r,target:s="_self"}=i;this.isValidUrl(r)&&("_parent"===s||"_top"===s?window.open(r,s):window.location.href=r,this.triggerEvent("iframe:redirect",{uuid:e,url:r,target:s}))}handleEvent(e,t,i){if(!t.config.allowEvents)return;const{eventName:r,data:s}=i;this.triggerEvent(`iframe:${r}`,{uuid:e,data:s})}handleError(e,t,i){console.error(`Smart Iframe Error [${e}]:`,i),this.triggerEvent("iframe:error",{uuid:e,error:i})}isValidUrl(e){try{const t=new URL(e);return["http:","https:"].includes(t.protocol)}catch{return!1}}on(e,t){return this.events.has(e)||this.events.set(e,new Set),this.events.get(e).add(t),()=>{this.events.get(e)?.delete(t)}}triggerEvent(e,t){const i=this.events.get(e);i&&i.forEach(i=>{try{i(t)}catch(t){console.error(`Error in event callback for ${e}:`,t)}})}sendToIframe(e,t,i){const r=this.iframes.get(e);if(!r?.isReady)return!1;const s={type:t,uuid:e,payload:i};return r.iframe.contentWindow?.postMessage(s,"*"),!0}removeIframe(e){const t=this.iframes.get(e);t&&(t.monitoringInterval&&clearInterval(t.monitoringInterval),t.container.removeChild(t.iframe),this.iframes.delete(e),this.triggerEvent("iframe:removed",{uuid:e}))}observeDOM(){if(!window.MutationObserver)return;new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(1===e.nodeType){e.hasAttribute("data-smart-iframe")&&this.createSmartIframe(e),e.classList?.contains("smartIframe")&&e.hasAttribute("data-src")&&this.createSimpleIframe(e);const t=e.querySelectorAll?.("[data-smart-iframe]");t?.forEach(e=>{e.id||this.createSmartIframe(e)});const i=e.querySelectorAll?.(".smartIframe[data-src]");i?.forEach(e=>{e.id||this.createSimpleIframe(e)})}})})}).observe(document.body,{childList:!0,subtree:!0})}addStyles(){if(document.getElementById("smart-iframe-styles"))return;const e=document.createElement("style");e.id="smart-iframe-styles",e.textContent="\n            .smart-iframe-container {\n                width: 100%;\n                position: relative;\n                overflow: hidden;\n            }\n            \n            .smart-iframe {\n                border: none;\n                width: 100%;\n                height: 200px;\n                display: block;\n                transition: height 0.3s ease;\n            }\n            \n            .smart-iframe.loading {\n                opacity: 0.7;\n            }\n            \n            .smart-iframe.error {\n                border: 2px solid #ff6b6b;\n                background: #ffe6e6;\n            }\n        ",document.head.appendChild(e)}generateUUID(){return"iframe_"+Math.random().toString(36).substr(2,9)+Date.now().toString(36)}getIframe(e){return this.iframes.get(e)}getAllIframes(){return Array.from(this.iframes.entries()).map(([e,t])=>({uuid:e,...t}))}}window.SmartIframeLoader=SmartIframeLoader,"undefined"!=typeof window&&(window.smartIframes=new SmartIframeLoader);