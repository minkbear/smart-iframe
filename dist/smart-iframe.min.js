class SmartIframeLoader{constructor(){this.iframes=new Map,this.events=new Map,this.messageTypes={RESIZE:"resize",REDIRECT:"redirect",EVENT:"event",READY:"ready",CONFIG:"config",ERROR:"error"},this.init()}init(){window.addEventListener("message",this.handleMessage.bind(this)),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",this.autoDetect.bind(this)):this.autoDetect(),this.observeDOM()}autoDetect(){document.querySelectorAll("[data-smart-iframe]").forEach(e=>{e.id||this.createSmartIframe(e)});document.querySelectorAll(".smartIframe[data-src]").forEach(e=>{e.id||this.createSimpleIframe(e)})}createSmartIframe(e){const t=this.parseConfig(e),r=this.generateUUID(),i=this.buildIframe(t,r);return e.id=r,e.appendChild(i),this.iframes.set(r,{container:e,iframe:i,config:t,isReady:!1}),this.addStyles(),i.addEventListener("load",()=>{this.sendConfig(r,t),this.tryAutoResize(r,t),this.startUrlMonitoring(r,t),this.setReadyWithFallback(r)}),r}createSimpleIframe(e){const t=e.dataset,r={src:t.src,allowResize:"false"!==t.resize,allowRedirect:"false"!==t.redirect,allowEvents:"false"!==t.events,maxHeight:parseInt(t.maxHeight)||parseInt(t.max)||9e3,minHeight:parseInt(t.minHeight)||parseInt(t.min)||400,initialHeight:parseInt(t.height)||parseInt(t.initialHeight)||800,scrolling:t.scrolling||"no",sandbox:t.sandbox||"allow-scripts allow-same-origin allow-forms",title:t.title||"Smart Iframe",validationDetection:t.validationDetection||"auto",successPatterns:t.successPatterns?t.successPatterns.split(","):["/success","/thank","/complete","/done"],errorPatterns:t.errorPatterns?t.errorPatterns.split(","):["same-url","/error","/invalid"],confirmOnUncertain:"false"!==t.confirmOnUncertain,debugMode:"true"===t.debugMode||"debug"===t.validationDetection,laravelMode:"true"===t.laravelMode,errorParams:t.errorParams?t.errorParams.split(","):["validation_status=error","errors=1","error=1"],successParams:t.successParams?t.successParams.split(","):["status=success","success=1"],validationTiming:parseInt(t.validationTiming)||500},i=this.generateUUID(),o=this.buildIframe(r,i);return e.id=i,e.appendChild(o),this.iframes.set(i,{container:e,iframe:o,config:r,isReady:!1}),this.addStyles(),o.addEventListener("load",()=>{this.sendConfig(i,r),this.tryAutoResize(i,r),this.startUrlMonitoring(i,r),this.setReadyWithFallback(i)}),i}parseConfig(e){const t=e.dataset;return{src:t.smartIframe,allowResize:"false"!==t.allowResize,allowRedirect:"false"!==t.allowRedirect,allowEvents:"false"!==t.allowEvents,maxHeight:parseInt(t.maxHeight)||null,minHeight:parseInt(t.minHeight)||200,initialHeight:parseInt(t.initialHeight)||200,scrolling:t.scrolling||"no",sandbox:t.sandbox||"allow-scripts allow-same-origin allow-forms",title:t.title||"Smart Iframe",validationDetection:t.validationDetection||"auto",successPatterns:t.successPatterns?t.successPatterns.split(","):["/success","/thank","/complete","/done"],errorPatterns:t.errorPatterns?t.errorPatterns.split(","):["same-url","/error","/invalid"],confirmOnUncertain:"false"!==t.confirmOnUncertain,debugMode:"true"===t.debugMode||"debug"===t.validationDetection,laravelMode:"true"===t.laravelMode,errorParams:t.errorParams?t.errorParams.split(","):["validation_status=error","errors=1","error=1"],successParams:t.successParams?t.successParams.split(","):["status=success","success=1"],validationTiming:parseInt(t.validationTiming)||500}}buildIframe(e,t){const r=document.createElement("iframe");let i=e.src;if(t){const e=i.includes("?")?"&":"?";i+=`${e}uuid=${t}`}return r.src=i,r.scrolling=e.scrolling,r.title=e.title,r.className="smart-iframe",e.sandbox&&(r.sandbox=e.sandbox),r.style.height=`${e.initialHeight}px`,r.setAttribute("loading","lazy"),r.setAttribute("referrerpolicy","strict-origin-when-cross-origin"),r}sendConfig(e,t){const r=this.iframes.get(e);if(!r)return;const i={type:this.messageTypes.CONFIG,uuid:e,config:{parentUrl:window.location.href,allowResize:t.allowResize,allowRedirect:t.allowRedirect,allowEvents:t.allowEvents}};r.iframe.contentWindow?.postMessage(i,"*")}tryAutoResize(e,t){if(!t.allowResize)return;const r=this.iframes.get(e);if(!r)return;const{iframe:i}=r;try{const r=i.contentDocument?.body?.scrollHeight;if(r&&r>t.initialHeight){let o=Math.max(r,t.minHeight);t.maxHeight&&(o=Math.min(o,t.maxHeight)),i.style.height=`${o}px`,this.triggerEvent("iframe:resize",{uuid:e,height:o,auto:!0})}}catch(r){this.setupScrollDetection(e,t)}}setupScrollDetection(e,t){const r=this.iframes.get(e);if(!r)return;const{iframe:i}=r;this.setupProgressiveResize(e,t),this.setupIntersectionResize(e,t),this.setupScrollBasedResize(e,t)}setupProgressiveResize(e,t){const r=this.iframes.get(e);if(!r)return;const{iframe:i}=r;let o=t.initialHeight;const a=t.maxHeight||Math.min(.8*window.innerHeight,1200);let n=0;const s=()=>{n>=20||(n++,o=Math.min(o+100,a),i.style.height=`${o}px`,this.triggerEvent("iframe:resize",{uuid:e,height:o,auto:!0,method:"progressive"}),o<a&&setTimeout(s,1500))};setTimeout(s,2e3)}setupIntersectionResize(e,t){if(!window.IntersectionObserver)return;const r=this.iframes.get(e);if(!r)return;const{iframe:i}=r,o=new IntersectionObserver(r=>{r.forEach(r=>{if(r.isIntersecting){const r=window.innerHeight,o=Math.min(.7*r,t.maxHeight||1e3);o>parseInt(i.style.height)&&(i.style.height=`${o}px`,this.triggerEvent("iframe:resize",{uuid:e,height:o,auto:!0,method:"intersection"}))}})},{threshold:.1});o.observe(i),r.intersectionObserver=o}setupScrollBasedResize(e,t){const r=this.iframes.get(e);if(!r)return;const{iframe:i}=r;["mouseenter","mouseover","focus","click"].forEach(r=>{i.addEventListener(r,()=>{const o=parseInt(i.style.height),a=t.maxHeight||Math.min(.9*window.innerHeight,1200);if(o<a){const t=Math.min(o+200,a);i.style.height=`${t}px`,this.triggerEvent("iframe:resize",{uuid:e,height:t,auto:!0,method:"event-based",trigger:r})}},{once:!0})})}setReadyWithFallback(e){const t=this.iframes.get(e);t&&setTimeout(()=>{t.isReady||this.handleReady(e,t)},3e3)}startUrlMonitoring(e,t){if(!t.allowRedirect)return;const r=this.iframes.get(e);if(!r)return;const{iframe:i}=r;let o=i.src;r.monitoring={originalSrc:o,redirectCount:0,lastActivity:Date.now(),formSubmitted:!1,initialPath:this.extractPath(o)},this.setupNavigationDetection(e),this.setupLoadEventMonitoring(e),this.setupPerformanceMonitoring(e),this.setupFormSubmissionMonitoring(e)}setupNavigationDetection(e){const t=this.iframes.get(e);if(!t)return;const{iframe:r}=t;if(t.config.laravelMode){let i=r.src;const o=new MutationObserver(o=>{o.forEach(o=>{if("attributes"===o.type&&"src"===o.attributeName){const o=r.src;o!==i&&(console.log("üîÑ Iframe src changed:",{old:i,new:o}),setTimeout(()=>{const i=r.src;console.log("üìç Checking stabilized src:",i);const o=t.config,a=this.detectLaravelFormResult(i,o);console.log("üîç Laravel detection on new src:",a),!1===a&&(console.log("‚ùå Validation error detected in new src!"),this.triggerEvent("iframe:form-validation-error",{uuid:e,timestamp:Date.now(),blockedRedirect:"src-change",method:"laravel-src-monitor",reason:"validation-params-in-changed-src",checkedUrl:i}))},500),i=o)}})});o.observe(r,{attributes:!0,attributeFilter:["src"]}),t.srcObserver=o}const i=()=>{if(t.monitoring.redirectCount++,t.monitoring.lastActivity=Date.now(),t.monitoring.formSubmitted){const i=Date.now()-t.monitoring.formSubmitTime;let o,a,n=!1;try{o=r.contentWindow.location.href,n=!0}catch{o=r.src||t.monitoring.originalSrc,n=!1,s.laravelMode&&r.src&&r.src!==t.monitoring.originalSrc&&(n=!0,console.log("Laravel mode: Using iframe.src as URL fallback:",r.src))}if(n){const t=this.extractPath(o);a=this.detectFormSubmissionSuccess(e,t,o)}else{const e=t.config;a="off"===e.validationDetection||(e.laravelMode?this.detectLaravelTimingSuccess(i,e):"strict"===e.validationDetection?t.monitoring.redirectCount>1:"loose"===e.validationDetection?i>500:(e.validationDetection,t.monitoring.redirectCount>1))}this.triggerEvent("iframe:form-result",{uuid:e,success:a,redirectCount:t.monitoring.redirectCount,timestamp:Date.now(),timeSinceSubmit:i,canAccessUrl:n,method:n?"url-comparison":"timing-heuristic"}),setTimeout(()=>{t.monitoring&&(console.log("üîÑ Resetting formSubmitted flag after delay"),t.monitoring.formSubmitted=!1,t.monitoring.expectedResult&&setTimeout(()=>{t.monitoring&&(console.log("üîÑ Clearing stored expected result"),delete t.monitoring.expectedResult,delete t.monitoring.expectedParams)},1e3))},500);const s=t.config,c=this.extractRedirectUrl(o);if(s.debugMode||"debug"===s.validationDetection){const r={success:a,method:n?"url-analysis":s.laravelMode?"laravel-timing":"load-count-heuristic",timeSinceSubmit:i,redirectCount:t.monitoring.redirectCount,canAccessUrl:n,currentPath:n?this.extractPath(o):"cross-origin",initialPath:t.monitoring.initialPath,redirectUrl:c||"form-success-redirect",reason:n?"url-comparison":`load-count: ${t.monitoring.redirectCount}`,laravelMode:s.laravelMode,urlParams:s.laravelMode&&o?new URL(o).search:null,laravelResult:s.laravelMode&&o?this.detectLaravelFormResult(o,s):null,laravelTiming:s.laravelMode&&!n?this.detectLaravelTimingSuccess(i,s):null};this.triggerEvent("iframe:debug-info",{uuid:e,debugData:r,timestamp:Date.now()}),this.showDebugDialog(e,r).then(t=>{t?a?this.performRedirect(e,c||"form-success-redirect"):console.log("Debug: User chose not to redirect (validation error detected)"):a?console.log("Debug: User cancelled successful redirect"):console.log("Debug: User cancelled validation error handling")})}else a?this.handleDetectedRedirect(e,c||"form-success-redirect",o):(this.triggerEvent("iframe:form-validation-error",{uuid:e,timestamp:Date.now(),timeSinceSubmit:i,reason:n?"pattern-match":"load-count",method:n?"url-analysis":"heuristic"}),s.confirmOnUncertain&&!n&&"auto"===s.validationDetection&&c&&this.showValidationConfirmDialog(e,c).then(t=>{t&&this.handleDetectedRedirect(e,c,o)}))}else{this.triggerEvent("iframe:navigation-detected",{uuid:e,timestamp:Date.now(),redirectCount:t.monitoring.redirectCount});const i=t.config;if(i.laravelMode){let o=null;try{o=r.src,console.log("Laravel navigation: Checking iframe.src:",o);const a=this.detectLaravelFormResult(o,i);if(console.log("Laravel navigation: Detection result:",a),!1===a)return console.log("Laravel navigation: Validation error detected in iframe URL"),void this.triggerEvent("iframe:form-validation-error",{uuid:e,timestamp:Date.now(),blockedRedirect:"navigation",method:"laravel-navigation",reason:"validation-params-in-iframe",checkedUrl:o});if(null===a){const r=new URL(t.monitoring.originalSrc),i=new URL(o);if(r.searchParams.delete("uuid"),i.searchParams.delete("uuid"),r.href===i.href){const r=!0===this.detectLaravelFormResult(o,t.config),i=t.monitoring?.expectedResult||t.expectedResult;if(!r&&("error"===i||t.monitoring.formSubmitted))return console.log("Laravel navigation: Same URL detected, likely session-based validation error"),void this.triggerEvent("iframe:form-validation-error",{uuid:e,timestamp:Date.now(),blockedRedirect:"navigation",method:"laravel-session",reason:"same-url-reload-detected",checkedUrl:o});r?(console.log("Laravel navigation: Same URL but success indicators found, allowing redirect"),t.monitoring&&(t.monitoring.formSubmitted=!1,delete t.monitoring.expectedResult,delete t.monitoring.expectedParams),this.triggerEvent("iframe:form-success",{uuid:e,timestamp:Date.now(),method:"laravel-success",checkedUrl:o})):(console.log("Laravel navigation: Same URL but no clear indication of error, allowing redirect"),t.monitoring&&(t.monitoring.formSubmitted=!1))}}}catch(e){console.log("Laravel navigation: Error checking iframe:",e)}}const o=this.extractRedirectUrl(t.monitoring.originalSrc);console.log("Extracted redirect URL from params:",o,"from:",t.monitoring.originalSrc),o?(console.log("Using redirect URL from parameter:",o),this.handleDetectedRedirect(e,o,t.monitoring.originalSrc)):(console.log("No redirect URL found in parameters, using cross-origin fallback"),this.handleDetectedRedirect(e,"cross-origin-navigation",t.monitoring.originalSrc))}};r.addEventListener("load",i),t.loadHandler=i}setupLoadEventMonitoring(e){const t=this.iframes.get(e);if(!t)return;const{iframe:r}=t;let i=0;const o=r.onload;r.onload=a=>{if(i++,i>1){let i="cross-origin-navigation";try{i=r.contentWindow.location.href}catch(e){r.src&&r.src!==t.monitoring.originalSrc&&(i=r.src)}this.handleDetectedRedirect(e,i,t.monitoring.originalSrc)}o&&o.call(r,a)}}setupPerformanceMonitoring(e){if(!window.PerformanceObserver)return;const t=this.iframes.get(e);if(t)try{const e=new PerformanceObserver(e=>{e.getEntries().forEach(e=>{e.entryType})});e.observe({entryTypes:["navigation"]}),t.performanceObserver=e}catch(e){}}extractRedirectUrl(e){try{const t=new URL(e),r=t.searchParams.get("p");if(r)return decodeURIComponent(r);const i=t.searchParams.get("redirect");if(i)return decodeURIComponent(i);const o=t.searchParams.get("return");return o?decodeURIComponent(o):null}catch{return null}}extractPath(e){try{const t=new URL(e);return t.pathname+t.search}catch{return e}}setupFormSubmissionMonitoring(e){this.iframes.get(e)}detectFormSubmissionSuccess(e,t,r){const i=this.iframes.get(e);if(!i)return!1;const o=i.config,a=i.monitoring.initialPath;if("off"===o.validationDetection)return!0;if(o.laravelMode&&r){const e=this.detectLaravelFormResult(r,o);if(null!==e)return e}const n=o.successPatterns||[];for(const e of n)if("path-change"===e){if(t!==a)return!0}else if(r&&r.includes(e))return!0;const s=o.errorPatterns||[];for(const e of s)if("same-url"===e||"same-path"===e){if(t===a)return!1}else if(r&&r.includes(e))return!1;return t!==a}detectLaravelFormResult(e,t){try{const r=new URL(e),i=r.searchParams,o=r.toString();console.log("detectLaravelFormResult: Checking URL:",e),console.log("detectLaravelFormResult: Error params to check:",t.errorParams),console.log("detectLaravelFormResult: URL params:",Array.from(i.entries()));const a=t.errorParams||[];for(const e of a)if(e.includes("=")){const[t,r]=e.split("="),o=i.get(t);if(console.log(`detectLaravelFormResult: Checking ${t}=${r}, found: ${o}`),o===r)return console.log("detectLaravelFormResult: ERROR DETECTED - validation error parameter found"),!1}else{const t=i.has(e),r=o.includes(`${e}=`);if(console.log(`detectLaravelFormResult: Checking param "${e}", has: ${t}, includes: ${r}`),t||r)return console.log("detectLaravelFormResult: ERROR DETECTED - error parameter exists"),!1}const n=t.successParams||[];for(const e of n)if(e.includes("=")){const[t,r]=e.split("=");if(i.get(t)===r)return!0}else if(i.has(e)||o.includes(`${e}=`))return!0;return null}catch{return null}}detectLaravelTimingSuccess(e,t){return!(e<(t.validationTiming||500))}showValidationConfirmDialog(e,t){return new Promise(e=>{confirm(`Form submitted. Redirect to ${t||"success page"}?`)?e(!0):e(!1)})}showDebugDialog(e,t){const{success:r,method:i,timeSinceSubmit:o,redirectCount:a,canAccessUrl:n,currentPath:s,initialPath:c,redirectUrl:l,reason:d,laravelMode:m,urlParams:g,laravelResult:u,laravelTiming:h,checkedUrl:f}=t,v=["üîç Debug Information:","",`Detection Method: ${i}`,"Form Success: "+(r?"YES":"NO"),`Reason: ${d}`,"","‚è±Ô∏è Timing:",`Time Since Submit: ${o}ms`,`Load Count: ${a}`,"","üåê URL Access:","Can Access URL: "+(n?"YES":"NO"),n?`Initial Path: ${c}`:"Cross-origin iframe detected",n?`Current Path: ${s}`:"Using load event heuristics",""];return m&&v.push("üöÄ Laravel Detection:","Laravel Mode: ENABLED",`URL Parameters: ${g||"none found"}`,`Checked URL: ${f||"unknown"}`,`Laravel URL Result: ${u||"no match"}`,`Laravel Timing Result: ${h||"not applicable"}`,""),v.push("üéØ Redirect:",`Target URL: ${l||"N/A"}`,"",r?"‚úÖ WILL REDIRECT":"‚ùå WON'T REDIRECT","","Continue with this decision?"),new Promise(e=>{console.group("üîç Smart Iframe Debug Information (Copy-friendly)"),console.log(v.join("\n")),console.groupEnd();const t=v.join("\n")+"\n\nüí° Tip: Debug info has been logged to browser console for easy copying (F12 ‚Üí Console)";e(confirm(t))})}handleDetectedRedirect(e,t,r){const i=this.iframes.get(e),o=i.config;if(i?.config.allowRedirect){if(this.triggerEvent("iframe:redirect-detected",{uuid:e,newUrl:t,oldUrl:r,redirectCount:i.monitoring?.redirectCount||0}),o.laravelMode&&"strict"===o.validationDetection){const r=i.monitoring?.expectedResult||i.expectedResult,a=i.monitoring?.expectedParams||i.expectedParams;if("error"===r&&a&&(t.includes("google.com")||t.includes("success")))return void this.triggerEvent("iframe:form-validation-error",{uuid:e,timestamp:Date.now(),blockedRedirect:t,method:"laravel-strict-mode",reason:"expected-validation-error-but-got-success-redirect",expectedParams:a});let n=null;const s=i.iframe;try{n=s.contentWindow.location.href}catch(e){s&&s.src&&(n=s.src)}if(n&&"about:blank"!==n||(n=t),n){return!1===this.detectLaravelFormResult(n,o)?void this.triggerEvent("iframe:form-validation-error",{uuid:e,timestamp:Date.now(),blockedRedirect:t,method:"laravel-strict-mode",reason:"validation-params-detected",checkedUrl:n}):void this.performRedirect(e,t)}}if((o.debugMode||"debug"===o.validationDetection)&&(!i.monitoring||!i.monitoring.formSubmitted)){let a=null,n=null,s=!0,c=null;if(o.laravelMode){if(c=t,!c||"cross-origin-navigation"===c){const e=i.iframe;try{c=e.contentWindow.location.href,console.log("Laravel debug: Using iframe.contentWindow.location.href:",c)}catch(t){if(console.log("Laravel debug: Cannot access contentWindow.location, trying iframe.src"),e&&e.src&&e.src!==i.monitoring?.originalSrc)c=e.src,console.log("Laravel debug: Using iframe.src as fallback:",e.src);else{console.log("Laravel debug: iframe.src unchanged, trying document methods");try{const t=e.contentDocument||e.contentWindow.document;t&&(c=t.URL||t.location.href,console.log("Laravel debug: Using iframe document URL:",c))}catch(e){console.log("Laravel debug: Cannot access iframe document, using fallbacks"),c=r,c&&"cross-origin-navigation"!==c||(c=i.monitoring?.originalSrc)}}}}if(c){n=new URL(c).search,a=this.detectLaravelFormResult(c,o);const e=i.monitoring?.expectedResult||i.expectedResult,t=i.monitoring?.expectedParams||i.expectedParams;console.log("üîç Laravel detection result:",{urlToCheck:c,laravelDetection:a,hasExpectedResult:!!e,expectedResult:e,monitoringKeys:i.monitoring?Object.keys(i.monitoring):null,iframeDataKeys:Object.keys(i)}),!1===a?s=!1:null===a&&"error"===e?(console.log("üîÑ Laravel detection failed, using stored expected result: error"),n=t||"stored-error-params",a=!1,s=!1):null===a&&console.log("‚ùå Laravel detection failed but no stored expected result found")}else{const e=i.monitoring?.expectedResult||i.expectedResult,t=i.monitoring?.expectedParams||i.expectedParams;console.log("üîç No URL found, checking stored expected result:",{hasMonitoring:!!i.monitoring,expectedResult:e,expectedParams:t}),"error"===e&&(console.log("üîÑ Using stored expected result: error"),n=t||"stored-error-params",a=!1,s=!1)}}const l={success:s,method:o.laravelMode?"laravel-navigation-check":"navigation-detection",timeSinceSubmit:"N/A (not form submission)",redirectCount:i.monitoring?.redirectCount||0,canAccessUrl:!1,currentPath:"navigation-redirect",initialPath:i.monitoring?.initialPath||"unknown",redirectUrl:t,reason:o.laravelMode&&!1===a?"laravel-error-params-detected":"navigation-detected",laravelMode:o.laravelMode,urlParams:n,laravelResult:a,checkedUrl:c};return this.triggerEvent("iframe:debug-info",{uuid:e,debugData:l,timestamp:Date.now()}),void this.showDebugDialog(e,l).then(r=>{r&&s?this.performRedirect(e,t):r&&!s?console.log("Debug: User confirmed Laravel validation error - blocking redirect"):console.log("Debug: User cancelled navigation redirect")})}if(i.monitoring&&i.monitoring.formSubmitted)if(o.laravelMode&&"strict"===o.validationDetection){console.log("üîç Laravel strict mode form check initiated");let r=null;const a=i.iframe;try{r=a.contentWindow.location.href,console.log("‚úÖ Laravel strict form check: Using iframe.contentWindow.location.href:",r)}catch(e){console.log("‚ùå Laravel strict form check: Cannot access contentWindow.location, trying iframe.src"),a&&a.src&&a.src!==i.monitoring?.originalSrc?(r=a.src,console.log("‚úÖ Laravel strict form check: Using iframe.src as fallback:",a.src)):console.log("‚ùå Laravel strict form check: iframe.src unchanged or not available")}if(console.log("üîç Laravel strict form check:",{urlToCheck:r,errorParams:o.errorParams,successParams:o.successParams}),r){const i=this.detectLaravelFormResult(r,o);if(console.log("üìä Laravel detection result:",i),!1===i)return console.log("üö´ Laravel strict mode: Form validation error detected, blocking redirect"),void this.triggerEvent("iframe:form-validation-error",{uuid:e,timestamp:Date.now(),blockedRedirect:t,method:"laravel-strict-form",reason:"validation-params-detected",checkedUrl:r});console.log("‚úÖ Laravel strict mode: No validation error detected, allowing redirect")}else console.log("‚ùå Laravel strict mode: No URL to check, cannot validate")}else if(r&&"cross-origin-navigation"!==r){if(this.extractPath(r)===i.monitoring.initialPath)return void this.triggerEvent("iframe:form-validation-error",{uuid:e,timestamp:Date.now(),blockedRedirect:t})}if(o.laravelMode&&!i.monitoring?.formSubmitted){let a=null;const n=i.iframe;try{a=n.contentWindow.location.href,console.log("Laravel non-debug: Using iframe.contentWindow.location.href:",a)}catch(e){if(console.log("Laravel non-debug: Cannot access contentWindow.location, trying iframe.src"),n&&n.src&&n.src!==i.monitoring?.originalSrc)a=n.src,console.log("Laravel non-debug: Using iframe.src as fallback:",n.src);else{console.log("Laravel non-debug: iframe.src unchanged, trying document methods");try{const e=n.contentDocument||n.contentWindow.document;e&&(a=e.URL||e.location.href,console.log("Laravel non-debug: Using iframe document URL:",a))}catch(e){console.log("Laravel non-debug: Cannot access iframe document, using fallbacks"),a=r,a&&"cross-origin-navigation"!==a||(a=i.monitoring?.originalSrc)}}}if(a){if(!1===this.detectLaravelFormResult(a,o))return void this.triggerEvent("iframe:form-validation-error",{uuid:e,timestamp:Date.now(),blockedRedirect:t,method:"laravel-url-params",reason:"validation-params-detected",checkedUrl:a})}}this.performRedirect(e,t)}}performRedirect(e,t){const r=this.iframes.get(e);if(r?.config.allowRedirect){if("cross-origin-navigation"===t){const t=r.config;if(t.laravelMode){const i=r.iframe;let o=null;try{o=i.src,console.log("Cross-origin Laravel: Checking iframe.src for validation params:",o);const a=new URL(o);console.log("Cross-origin Laravel: URL search params:",a.search),console.log("Cross-origin Laravel: Error params to check:",t.errorParams);const n=this.detectLaravelFormResult(o,t);if(console.log("Cross-origin Laravel: Detection result:",n),!1===n)return console.log("Cross-origin Laravel: Validation error detected, blocking redirect"),void this.triggerEvent("iframe:form-validation-error",{uuid:e,timestamp:Date.now(),blockedRedirect:"cross-origin",method:"laravel-cross-origin",reason:"validation-params-in-iframe-src",checkedUrl:o});const s=r.monitoring?.formSubmitted,c=s?Date.now()-(r.monitoring?.formSubmitTime||0):null;if(s&&c&&c<3e3){const t=new URL(r.monitoring.originalSrc),i=new URL(o);if(t.searchParams.delete("uuid"),i.searchParams.delete("uuid"),t.href===i.href)return console.log("Cross-origin Laravel: Same URL after form submission, likely validation error"),this.triggerEvent("iframe:form-validation-error",{uuid:e,timestamp:Date.now(),blockedRedirect:"cross-origin",method:"laravel-session-cross-origin",reason:"same-url-after-form-submit",checkedUrl:o}),void(r.monitoring.formSubmitted=!1)}const l=this.extractRedirectUrl(r.monitoring.originalSrc);if(l&&(!s||!0===n))return console.log("Cross-origin: Found redirect URL in parameters, redirecting to:",l),window.location.href=l,void this.triggerEvent("iframe:redirect",{uuid:e,url:l,target:"_self",detected:!0,auto:!0,method:"parameter-redirect"});if(l&&s)return console.log("Cross-origin: Redirect blocked due to form submission without success indicators"),void this.triggerEvent("iframe:form-validation-error",{uuid:e,timestamp:Date.now(),blockedRedirect:l,method:"laravel-cross-origin-form",reason:"no-success-indicators-after-form-submit"})}catch(e){console.log("Cross-origin Laravel: Error checking iframe:",e)}return console.log("Cross-origin navigation detected - cannot auto-redirect for security"),void this.triggerEvent("iframe:cross-origin-blocked",{uuid:e,timestamp:Date.now(),reason:"cross-origin-security"})}return void console.log("Redirect blocked: cross-origin navigation")}t&&this.isValidUrl(t)?(window.location.href=t,this.triggerEvent("iframe:redirect",{uuid:e,url:t,target:"_self",detected:!0,auto:!0})):console.log("Redirect blocked: invalid URL")}}shouldAllowAutoRedirect(e,t){try{const r=new URL(e),i=new URL(t);return r.hostname===i.hostname}catch{return!1}}handleMessage(e){if(console.log("üì® Message received:",e.data),e.data&&"IFRAME_URL_UPDATE"===e.data.type){const{uuid:t,url:r,search:i,pathname:o}=e.data,a=this.iframes.get(t);if(a&&(console.log("üîó Iframe URL update received:",{uuid:t,url:r,search:i}),a.config.laravelMode)){const e=this.detectLaravelFormResult(r,a.config);console.log("Laravel detection on URL update:",e),!1===e&&(console.log("‚ùå Validation error detected from iframe URL update!"),this.triggerEvent("iframe:form-validation-error",{uuid:t,timestamp:Date.now(),blockedRedirect:"iframe-url-update",method:"laravel-postmessage",reason:"validation-params-detected-via-postmessage",checkedUrl:r}))}return}if(e.data&&"VALIDATION_ERROR_DETECTED"===e.data.type){const{uuid:t,url:r,hasErrors:i}=e.data;return void(this.iframes.get(t)&&i&&(console.log("‚ùå Validation error detected by iframe injector!"),this.triggerEvent("iframe:form-validation-error",{uuid:t,timestamp:Date.now(),blockedRedirect:"validation-detected",method:"laravel-injector",reason:"validation-errors-detected-in-dom",checkedUrl:r})))}if(!this.isValidMessage(e))return void console.log("‚ùå Invalid message, ignoring");const{type:t,uuid:r,payload:i}=e.data,o=this.iframes.get(r);if(o)switch(console.log("‚úÖ Processing message:",{type:t,uuid:r,payload:i}),t){case this.messageTypes.READY:this.handleReady(r,o);break;case this.messageTypes.RESIZE:this.handleResize(r,o,i);break;case this.messageTypes.REDIRECT:this.handleRedirect(r,o,i);break;case this.messageTypes.EVENT:this.handleEvent(r,o,i);break;case"FORM_SUBMIT":const t=e.data;this.handleFormSubmit(r,o,t);break;case this.messageTypes.ERROR:this.handleError(r,i)}else console.log("‚ùå No iframe data found for UUID:",r)}isValidMessage(e){try{const{type:t,uuid:r}=e.data;return t&&r&&this.iframes.has(r)}catch{return!1}}handleReady(e,t){t.isReady||(t.isReady=!0,this.triggerEvent("iframe:ready",{uuid:e,iframe:t}))}handleResize(e,t,r){if(!t.config.allowResize)return;const{height:i,width:o}=r,{iframe:a,config:n}=t;if(i){let e=Math.max(i,n.minHeight);n.maxHeight&&(e=Math.min(e,n.maxHeight)),a.style.height=`${e}px`}o&&(a.style.width=`${o}px`),this.triggerEvent("iframe:resize",{uuid:e,height:i,width:o})}handleRedirect(e,t,r){if(!t.config.allowRedirect)return;const{url:i,target:o="_self"}=r;this.isValidUrl(i)&&("_parent"===o||"_top"===o?window.open(i,o):window.location.href=i,this.triggerEvent("iframe:redirect",{uuid:e,url:i,target:o}))}handleEvent(e,t,r){if(!t.config.allowEvents)return;const{eventName:i,data:o}=r;this.triggerEvent(`iframe:${i}`,{uuid:e,data:o})}handleError(e,t){console.error(`Smart Iframe Error [${e}]:`,t),this.triggerEvent("iframe:error",{uuid:e,error:t})}handleFormSubmit(e,t,r){const i=Date.now();console.log("üöÄ FORM_SUBMIT received at",i,":",e,r),t.monitoring?(t.monitoring.formSubmitted=!0,t.monitoring.formSubmitTime=i,r&&r.expectedResult&&(t.monitoring.expectedResult=r.expectedResult,t.monitoring.expectedParams=r.expectedParams,t.expectedResult=r.expectedResult,t.expectedParams=r.expectedParams,console.log("üìù Stored expected result:",r.expectedResult,r.expectedParams)),console.log("‚úÖ Form submission marked for UUID at",i,":",e),console.log("üìä Current iframe monitoring state:",t.monitoring),this.triggerEvent("iframe:form-submitting",{uuid:e,formId:r?r.formId:void 0,method:r?r.method:void 0,action:r?r.action:void 0,timestamp:i})):console.log("‚ùå No monitoring data for UUID:",e)}isValidUrl(e){try{const t=new URL(e);return["http:","https:"].includes(t.protocol)}catch{return!1}}on(e,t){return this.events.has(e)||this.events.set(e,new Set),this.events.get(e).add(t),()=>{this.events.get(e)?.delete(t)}}triggerEvent(e,t){const r=this.events.get(e);r&&r.forEach(r=>{try{r(t)}catch(t){console.error(`Error in event callback for ${e}:`,t)}})}sendToIframe(e,t,r){const i=this.iframes.get(e);if(!i?.isReady)return!1;const o={type:t,uuid:e,payload:r};return i.iframe.contentWindow?.postMessage(o,"*"),!0}removeIframe(e){const t=this.iframes.get(e);t&&(t.monitoringInterval&&clearInterval(t.monitoringInterval),t.container.removeChild(t.iframe),this.iframes.delete(e),this.triggerEvent("iframe:removed",{uuid:e}))}observeDOM(){if(!window.MutationObserver)return;new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(1===e.nodeType){e.hasAttribute("data-smart-iframe")&&this.createSmartIframe(e),e.classList?.contains("smartIframe")&&e.hasAttribute("data-src")&&this.createSimpleIframe(e);const t=e.querySelectorAll?.("[data-smart-iframe]");t?.forEach(e=>{e.id||this.createSmartIframe(e)});const r=e.querySelectorAll?.(".smartIframe[data-src]");r?.forEach(e=>{e.id||this.createSimpleIframe(e)})}})})}).observe(document.body,{childList:!0,subtree:!0})}addStyles(){if(document.getElementById("smart-iframe-styles"))return;const e=document.createElement("style");e.id="smart-iframe-styles",e.textContent="\n            .smart-iframe-container {\n                width: 100%;\n                position: relative;\n                overflow: hidden;\n            }\n            \n            .smart-iframe {\n                border: none;\n                width: 100%;\n                height: 200px;\n                display: block;\n                transition: height 0.3s ease;\n            }\n            \n            .smart-iframe.loading {\n                opacity: 0.7;\n            }\n            \n            .smart-iframe.error {\n                border: 2px solid #ff6b6b;\n                background: #ffe6e6;\n            }\n        ",document.head.appendChild(e)}generateUUID(){return"iframe_"+Math.random().toString(36).substring(2,11)+Date.now().toString(36)}getIframe(e){return this.iframes.get(e)}getAllIframes(){return Array.from(this.iframes.entries()).map(([e,t])=>({uuid:e,...t}))}}window.SmartIframeLoader=SmartIframeLoader,"undefined"!=typeof window&&(window.smartIframes=new SmartIframeLoader);